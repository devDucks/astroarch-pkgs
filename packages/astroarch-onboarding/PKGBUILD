# Maintainer: Mattia Procopio (astro.matto) <matto.astro at gmail dot com>
pkgname=astroarch-onboarding
pkgver=1.1.2
pkgrel=1
pkgdesc='AstroArch onboarding'
arch=(aarch64)
url="https://github.com/devDucks/astroarch-onboarding"
license=('BSD-2-Clause'
	'CC-BY-4.0'
	'CC0-1.0'
	'GPL-3.0-or-later'
	'LGPL-2.1-only'
	'LGPL-3.0-or-later'
	'MIT')
depends=('ckbcomp'
	'perl-xml-parser'
	'perl-xml-writer'
	'sysfsutils'
	'setconf'
	'cmake'
	'yaml-cpp')
makedepends=('extra-cmake-modules' 'git')
source=(https://github.com/sc74/astroarch-onboarding/archive/refs/heads/calamares.zip)
sha256sums=('b9bf44b1e5b14afb6c2e6e0e403e857687de2bdf806f7bf92cb1b5d5cc9229ae')

build() {
	cd "${srcdir}/${pkgname}-calamares"
	mkdir -p build
	cd build
	cmake -DCMAKE_BUILD_TYPE=release -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_INSTALL_LIBDIR=lib -DWITH_QT6=ON -DINSTALL_CONFIG=ON ..
	make -j$(nproc)
}

package() {
	cd "${srcdir}/${pkgname}-calamares/build"
	make DESTDIR="$pkgdir" install
	mkdir -p "$pkgdir/home/astronaut/"
	mkdir -p "$pkgdir/etc/polkit-1/rules.d/"
	mkdir -p "$pkgdir/home/astronaut/.config/astroarch_onboarding"
	cp -R "${srcdir}/${pkgname}-calamares/src/branding/astroarch" "$pkgdir/usr/share/calamares/branding/"
	cp -R "${srcdir}/${pkgname}-calamares/src/astroarch_onboarding" "$pkgdir/home/astronaut/.config/"
	rm -f "$pkgdir/usr/share/polkit-1/actions/com.github.calamares.calamares.policy"
	cp -R "${srcdir}/${pkgname}-calamares/src/astroarch_onboarding/configs/com.github.calamares.calamares.policy" "$pkgdir/usr/share/polkit-1/actions/com.github.calamares.calamares.policy"
	cp -R "${srcdir}/${pkgname}-calamares/src/astroarch_onboarding/configs/49-nopasswd-calamares-vnc.rules" "$pkgdir/etc/polkit-1/rules.d/49-nopasswd-calamares-vnc.rules"
	cp -R "${srcdir}/${pkgname}-calamares/src/astroarch_onboarding/configs/49-nopasswd-calamares-xrdp.rules" "$pkgdir/etc/polkit-1/rules.d/49-nopasswd-calamares-xrdp.rules"
}
